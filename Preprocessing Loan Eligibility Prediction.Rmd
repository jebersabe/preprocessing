---
title: "Preprocessing Loan Eligibility Prediction"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
author: "Jake Bersabe"
date: "14/11/2021"
output: html_document
---

#### Import the data set  

```{r message=FALSE}
library(dplyr)
data <- readr::read_csv("train.csv")
glimpse(data)
```

```{r message=FALSE}
library(skimr)
skim(data)
```  


### Split data set  
```{r}
library(rsample)

data_xplit <- initial_split(data, strata = Loan_Status)

data_train <- training(data_xplit)
data_test <- testing(data_xplit)

```



## Preprocessing 1: Step by step
### 1. Imputation, deselect LoanID   
```{r message=FALSE}
library(mice)

data_train1 <- data_train %>% 
  mutate(Gender = factor(Gender),
         Married = factor(Married),
         Education = factor(Education),
         Self_Employed = factor(Self_Employed),
         Property_Area = factor(Property_Area)) %>% 
  select(-Loan_ID) %>% 
  mice(m=2, maxit = 2, method = 'cart', seed = 500) %>% 
  complete(1)

colSums(is.na(data_train1))
```

### 2. Feature engineering:  Add CombinedIncome column, Deselect applicant and coapplicant income, add MonthlyPayment column, PaymentIncomeRatio column 

First, create a function that will compute monthly payment.  
```{r}
monthly_payment <- function(loan_amount, loan_amount_term){
  r <- 0.005
  monthly_payment <- (loan_amount/(((1+r)^loan_amount_term)-1))*(((1+r)^loan_amount_term)*r)
  return(monthly_payment)
}
```



```{r}
data_train2 <- data_train1 %>% 
  mutate(LoanAmount = LoanAmount*1000,
         CombinedIncome = ApplicantIncome + CoapplicantIncome) %>% 
  select(-ApplicantIncome, -CoapplicantIncome) %>% 
  mutate(MonthlyPayment = monthly_payment(LoanAmount, Loan_Amount_Term),
         PaymentIncomeRatio = MonthlyPayment/CombinedIncome)
glimpse(data_train2)
```




### 3. Dummy Coding  
```{r}
data_train3 <- data_train2 %>% 
  mutate(Gender = if_else(Gender == "Male", 1, 0),
         Married = if_else(Married == "Yes", 1, 0),
         Education = if_else(Education == "Graduate", 1, 0),
         Self_Employed = if_else(Self_Employed == "Yes", 1, 0),
         Credit_History = as.numeric(as.character(Credit_History)),
         Property_Area_Semi = if_else(Property_Area == "Semiurban", 1, 0),
         Property_Area_Rural = if_else(Property_Area == "Rural", 1, 0),
         Property_Area_Urban = if_else(Property_Area == "Urban", 1, 0),
         Loan_Status = if_else(Loan_Status == "Y", 1, 0)) %>% 
  select(-Property_Area)
data_train3 %>% glimpse()
```


### 4. Normalization  
```{r}
data_train4 <- scale(data_train3) %>% as_tibble()
glimpse(data_train4)
```

```{r}
library(corrplot)
data_train4 %>% 
  select(-LoanAmount, -Loan_Amount_Term, -CombinedIncome, -MonthlyPayment) %>% 
  cor() %>% 
  corrplot(type = "lower")
```


## Preprocessing 2: Pipeline  
```{r}
# Library for imputation
library(mice) 

# Function to add monthly income column
monthly_payment <- function(loan_amount, loan_amount_term){
  r <- 0.005
  monthly_payment <- (loan_amount/(((1+r)^loan_amount_term)-1))*(((1+r)^loan_amount_term)*r)
  return(monthly_payment)
} 

# Pre-processing pipeline 

data_train_pipelined <- data_train %>%
  mutate(Gender = factor(Gender),
         Married = factor(Married),
         Education = factor(Education),
         Self_Employed = factor(Self_Employed),
         Property_Area = factor(Property_Area)) %>% 
  select(-Loan_ID) %>% 
  mice(m=2, maxit = 2, method = 'cart', seed = 500) %>% 
  complete(1) %>% 
  mutate(LoanAmount = LoanAmount*1000,
         CombinedIncome = ApplicantIncome + CoapplicantIncome) %>% 
  select(-ApplicantIncome, -CoapplicantIncome) %>% 
  mutate(MonthlyPayment = monthly_payment(LoanAmount, Loan_Amount_Term),
         PaymentIncomeRatio = MonthlyPayment/CombinedIncome) %>% 
  mutate(Gender = if_else(Gender == "Male", 1, 0),
         Married = if_else(Married == "Yes", 1, 0),
         Education = if_else(Education == "Graduate", 1, 0),
         Self_Employed = if_else(Self_Employed == "Yes", 1, 0),
         Credit_History = as.numeric(as.character(Credit_History)),
         Property_Area_Semi = if_else(Property_Area == "Semiurban", 1, 0),
         Property_Area_Rural = if_else(Property_Area == "Rural", 1, 0),
         Property_Area_Urban = if_else(Property_Area == "Urban", 1, 0),
         Loan_Status = if_else(Loan_Status == "Y", 1, 0)) %>% 
  select(-Property_Area) %>% 
  scale() %>% 
  as_tibble()
  
glimpse(data_train_pipelined)
skim(data_train_pipelined)
```


## Compare Preprocessing 1 and Preprocessing 2  
```{r}
waldo::compare(data_train_pipelined, data_train4)
```


## Preprocessing 3: recipes()  
```{r}
library(recipes)

data_train %>% 
  recipe() %>% 
    step_mutate(Credit_History = case_when(
      Credit_History == 1 ~ "Yes",
      Credit_History == 0 ~ "No",
      is.na(Credit_History) ~ "NoHistory")) %>% 
    step_mutate(Gender = factor(Gender),
                Married = factor(Married),
                Education  = factor(Education),
                Self_Employed = factor(Self_Employed),
                Property_Area = factor(Property_Area),
                Credit_History  = factor(Credit_History)) %>% 
    step_impute_mode(Gender, Married, Self_Employed) %>% 
    step_impute_median(LoanAmount, Dependents, Loan_Amount_Term) %>% 
    step_mutate(CombinedIncome = ApplicantIncome + CoapplicantIncome,
                MonthlyPayment  = LoanAmount*1000/Loan_Amount_Term,
                PaymentIncomeRatio = MonthlyPayment/CombinedIncome) %>% 
    step_select(-Loan_ID) %>% 
    step_dummy(Gender, Married, Education, 
               Self_Employed, Credit_History, Property_Area) %>% 
    step_normalize(everything()) %>% 
  prep()
```


```{r}
data_train %>% 
  mutate(Credit_History = case_when(
    Credit_History == 1 ~ "Yes",
    Credit_History == 0 ~ "No",
    is.na(Credit_History) ~ "NoHistory")) %>% 
  mutate(Gender = if_else(is.na(Gender), "Male", Gender),
         Married = if_else(is.na(Married), "Yes", Married),
         Self_Employed = if_else(is.na(Self_Employed), "No", Self_Employed),
         LoanAmount = if_else(is.na(LoanAmount), median(LoanAmount, na.rm=T), LoanAmount),
         Dependents = if_else(is.na(Dependents), median(Dependents, na.rm=T), Dependents),
         Loan_Amount_Term = if_else(is.na(Loan_Amount_Term), median(Loan_Amount_Term, na.rm=T), Loan_Amount_Term),
         CombinedIncome = ApplicantIncome + CoapplicantIncome,
         MonthlyPayment  = LoanAmount*1000/Loan_Amount_Term,
         PaymentIncomeRatio = MonthlyPayment/CombinedIncome) %>% 
  mutate(Gender = if_else(Gender == "Male", 1, 0),
         Married = if_else(Married == "Yes", 1, 0),
         Education = if_else(Education == "Graduate", 1, 0),
         Self_Employed = if_else(Self_Employed == "Yes", 1, 0),
         Credit_History_Yes = if_else(Credit_History == "Yes", 1, 0),
         Credit_History_No = if_else(Credit_History == "No", 1, 0),
         Credit_History_NA = if_else(Credit_History == "NoHistory", 1, 0),
         Property_Area_Semi = if_else(Property_Area == "Semiurban", 1, 0),
         Property_Area_Rural = if_else(Property_Area == "Rural", 1, 0),
         Property_Area_Urban = if_else(Property_Area == "Urban", 1, 0),
         Loan_Status = if_else(Loan_Status == "Y", 1, 0)) %>% 
  select(-Loan_ID, -Credit_History, -Property_Area) %>% 
  scale() %>% 
  as_tibble()
  
  
```

